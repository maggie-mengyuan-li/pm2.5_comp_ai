---
title: "Part 5: Descriptive plots showing mean annual PM2.5, national and by state"
author: "Maggie Li (ml4424)"
date: "9/25/2020"
output: html_document
---

```{r}
library(tidyverse)
library(gridExtra)
library(grid)
library(ggplot2)
library(lattice)
library(lme4)
library(gamm4)
```


##  State Line Graphs showing PM2.5 declines (nh4/model)

### 10/22 update: plotting adjusted annual declines.
We are plotting adjusted annual national PM2.5 averages by using our fitted LMER Model 4.

### 9/25 update: plotting adjusted annual declines 
We are plotting adjusted annual national PM2.5 averages by using our fitted LMER Model 3. The estimated values are the y-values predicted from Model 3 "offseted" by adding the model intercept (grand mean PM2.5), and effect of HH income and population density by adding the weighted average beta value for both variables.

### nh4 Data

```{r Create Dataframe of annual mean PM2.5 adjusted in all counties}
# Read in state FIPS dataset
state_fips <- read_csv("data/state_fips.csv")
state_fips <- state_fips %>% dplyr::select(State_Name, State)

# Define subsetted df for native counties (nh4) to be used in later chunks for unadjusted line
nh4_ai_join = read_csv("data/county_concentrations/joined_dta/nh4_ai_join.csv")
nh4_ai <- nh4_ai_join %>% filter(county_type == 1)

# Join with data to get state acronyms
nh4_ai <- nh4_ai %>% 
  dplyr::select(County, year, nh4, State)
nh4_ai$year <- as.factor(nh4_ai$year)
unique(nh4_ai$State_Name)
nh4_ai <- nh4_ai %>% inner_join(state_fips)
nh4_ai #each row represents a county-year annual PM2.5 concentration

# Define subsetted df for non-native counties (nh4) to be used in later chunks for unadjusted line
nonnh4_ai <- nh4_ai_join %>% filter(county_type == 0)
# Join with data to get state acronyms
nonnh4_ai <- nonnh4_ai %>% 
  dplyr::select(County, year, nh4, State)
nonnh4_ai$year <- as.factor(nonnh4_ai$year)
unique(nonnh4_ai$State_Name)
nonnh4_ai <- nonnh4_ai %>% inner_join(state_fips)
nonnh4_ai

# 9/25 Re-doing the adjusted national annual averages
## Duplicate df with all annual averages data to use
nh4.all <- nh4_ai_join
nh4.all$county_type <- as.factor(nh4.all$county_type)

## Set referent group 
nh4.all$county_type <- relevel(nh4.all$county_type, ref = "0")

 

## Fit linear mixed effect regression model to the data (ref = 0)
mod.all.nh4 <-  gamm4(nh4 ~ county_type*as.factor(year) + popd_q + hhinc_q,
                 random =~(1|State/County),
                 data = nh4.all)
summary(mod.all.nh4$gam)

## 3/18/2022 try with spline term to compare gamm and glmm predictions
# mod.all.nh4 = gamm4(nh4 ~ county_type +
#                                  s(year, by = county_type, k = 10) + # specify k knots
#                                  popd_q +
#                                  hhinc_q,
#                                random = ~(1|State/County),
#                                data =  nh4_ai_join)
# summary(mod.all.nh4$gam)
# mod.all.nh4.gam = mod.all.nh4

## OG as of pre-11/30/2020
# pred_df =
#    expand_grid(
#       year = 2000:2018,
#       county_type = c(0,1),
#       popd_q = "(196,304]",
#       hhinc_q = "(4.19e+04,4.39e+04]"
#    )

## most common decile--not in use
# nh4.all %>% 
#   group_by(county_type, popd_q) %>% 
#   summarize(N = n()) %>% 
#   filter(N==max(N))

## most common AI decile--not in use
# pred_df_AI =
#    expand_grid(
#       year = 2000:2017,
#       county_type = c(0,1),
#       popd_q = "(4.4,12.7]",
#       hhinc_q = "(3.56e+04,3.8e+04]"
#    )

## most common non-AI decile--not in use
# pred_df_nonAI =
#    expand_grid(
#       year = 2000:2017,
#       county_type = c(0,1),
#       popd_q = "(160,382]",
#       hhinc_q = "(5.75e+04,1.16e+05]"
#    )

# UPDATE 7/25/22
## decile group for ALL counties that overlaps with 7th decile of AI-COUNTIES for each covariate ***USE THIS FOR ADJUSTED PM VALUES DESCRIPTIVE GRAPH***; see bc_descriptive_graphs.Rmd for comparison of the decile groups
pred_df =
   expand_grid(
      year = 2000:2017,
      county_type = c(0,1),
      popd_q = "(22.4,32.7]",
      hhinc_q = "(4.03e+04,4.24e+04]"
   )

## ***ADJUSTED PM VALUES!*** 
nh4_adj  <- 
  pred_df %>% 
   modelr::add_predictions(mod.all.nh4$gam)

## JUST TO TEST
# nh4_adj = nh4.all %>% 
#   modelr::add_predictions(mod.all.nh4$gam) %>% 
#   group_by(year, county_type) %>% 
#   summarize(nh4 = mean(pred))

# ## JUST TO CHECK WITH BELOW: average decline AI nh4 with most common AI decile
# nh4_adj_AI %>% 
#   filter(county_type == 1) %>% pull(pred) %>% first() - 
#   nh4_adj_AI %>% 
#   filter(county_type == 1) %>% pull(pred) %>% last()
# 
# ## average decline non-AI nh4
# nh4_adj_AI %>% 
#   filter(county_type == 0) %>% pull(pred) %>% first() - 
#   nh4_adj_AI %>% 
#   filter(county_type == 0) %>% pull(pred) %>% last()
# 
# ## JUST TO CHECK WITH ABOVE: average decline AI nh4 with most common non-AI decile
# nh4_adj_nonAI %>% 
#   filter(county_type == 1) %>% pull(pred) %>% first() - 
#   nh4_adj_nonAI %>% 
#   filter(county_type == 1) %>% pull(pred) %>% last()
# 
# ## average decline non-AI nh4
# nh4_adj_nonAI %>% 
#   filter(county_type == 0) %>% pull(pred) %>% first() - 
#   nh4_adj_nonAI %>% 
#   filter(county_type == 0) %>% pull(pred) %>% last()

## ## edit year column to be a factor
nh4_adj$year <- as.factor(nh4_adj$year)

## add additional ID column for group aes in ggplot
nh4_adj$State_Name <- "Adjusted Mean (All States)"

##rename pred column to nh4 to match unadjusted lines (see below)
nh4_adj <- nh4_adj %>% 
  rename(nh4 = pred)
nh4_adj

## AI ADJUSTED nh4
ai_nh4_adj <- nh4_adj %>% 
  filter(county_type == 1)

## NON-AI ADJUSTED nh4
nai_nh4_adj <- nh4_adj %>% 
  filter(county_type == 0)

ai_nh4_adj
nai_nh4_adj

```


```{r Get unadjusted mean PM2.5 for AI counties & Plot all adj and unadj values}

## Unadjusted STATE lines: Aggregate to get an average exposure for each STATE per year
native_state_annual_mean <- aggregate(nh4~year+State_Name,
          data=nh4_ai,
          FUN=mean)
native_state_annual_mean 
#3 year moving avg
#separate df by state FIPS and rbind back
state_analysis <- list() #empty list for county
native_state_exp <- unique(native_state_annual_mean$State_Name)
native_exp_final <- data.frame() #empty df to rbind list items into
library(stats)
for (i in 1:length(native_state_exp)){
  #separate df by state
  state_analysis[[i]] <- native_state_annual_mean %>%
    filter(State_Name == native_state_exp[i])
  #new col of moving averages
  state_analysis[[i]] <- state_analysis[[i]] %>%
    group_by(year) %>%
    arrange(year) 
  #new column for moving averages
  state_analysis[[i]]$movave <- (state_analysis[[i]]$nh4 + 
                                    lag(state_analysis[[i]]$nh4) + 
                                    lag(state_analysis[[i]]$nh4,2))/3
  #fill first year entry with just first year entry
  state_analysis[[i]][1,"movave"] <- state_analysis[[i]]$nh4[1]
  #fill second year with avg from first and second year
  state_analysis[[i]][2,"movave"] <- mean(c(state_analysis[[i]]$nh4[1],
                                           state_analysis[[i]]$nh4[2]))
  #rebind df
  native_exp_final <- do.call(rbind, state_analysis)
}

native_exp_final 
# native_exp_final$year <- substr(native_exp_final$year, 3, 4)
native_exp_final$year <- as.factor(native_exp_final$year)
#fill in NAs in movave column; have first year be the first year, 2nd year be 2 year moving avg
native_exp_final$county_type <- "American Indian"

## UNADJUSTED NATIONWIDE TRENDS: df for NATIONWIDE average decline, to join with table
native_avgdec <- aggregate(nh4~year,
                           data=native_exp_final,
                           FUN=mean)
# code moving average column
native_avgdec$movave <- (native_avgdec$nh4 + 
                                  lag(native_avgdec$nh4) + 
                                  lag(native_avgdec$nh4,2))/3
native_avgdec[1,"movave"] <- native_avgdec$nh4[1]
#fill second year with avg from first and second year
native_avgdec[2,"movave"] <- mean(c(native_avgdec$nh4[1],
                                    native_avgdec$nh4[2]))

# dummy columns
native_avgdec$State_Name <- "Average Concentration across all States (Unadjusted)"
native_avgdec$county_type <- "American Indian"
native_avgdec <- native_avgdec %>% dplyr::select(year, State_Name, nh4, movave, county_type)

native_exp_final

# PLOT
nh4_ai_timetrend <- ggplot() + 
  geom_line(data = native_exp_final,
            aes(x=year, y = nh4,
                group = State_Name, colour= State_Name),
            color = "grey") + #each line = state mean
  geom_line(data=native_avgdec,
            aes(x=year, y=nh4,
                group=State_Name),
            color="black",
            size = 1.25) + #unadjusted national mean
  geom_line(data= ai_nh4_adj,
            aes(x=year, y=nh4,
                group=State_Name),
            color = "purple",
            size = 1.25) + #adjusted national mean
  ylim(0,5) +
  ylab(expression(paste("Annual Measured ", PM[2.5], " (", mu, "g/", m^3, ")"))) +
  labs(#title = "AI Populated Counties",
       x = "Year") + theme_linedraw()  +
  theme(plot.title = element_text(size = 18),
        axis.title = element_text(size = 16),
        axis.text = element_text(size = 12),
        axis.title.x=element_blank()) +
  guides(x =  guide_axis(angle = 45)) 
nh4_ai_timetrend

# customlabel inside graph
grob_nh4_ai <- grobTree(textGrob("A", x=0.05,  y=0.9, hjust=0,
  gp=gpar(fontsize=30)))

# Final Plot & save it
nh4_ai_timetrend  + annotation_custom(grob_nh4_ai)
# ggsave("figures/updated_10.22/nh4_ai_states.png")
```

```{r Get unadjusted mean PM2.5 for non-AI counties & Plot all adj and unadj values}

# STATE TREND LINES: Aggregate to get an average exposure for each state per year (unadjusted)
nonnative_state_annual_mean <- aggregate(nh4~year+State_Name,
          data=nonnh4_ai,
          FUN=mean)
nonnative_state_annual_mean

#3 year moving avg
#separate df by state FIPS and rbind back
state_analysis <- list() #empty list for county
nonnative_state_exp <- unique(nonnative_state_annual_mean$State_Name)
nonnative_exp_final <- data.frame() #empty df to rbind list items into
library(stats)
for (i in 1:length(nonnative_state_exp)){
  #separate df by state
  state_analysis[[i]] <- nonnative_state_annual_mean %>%
    filter(State_Name == nonnative_state_exp[i])
  #new col of moving averages
  state_analysis[[i]] <- state_analysis[[i]] %>%
    group_by(year) %>%
    arrange(year) 
  #new column for moving averages
  state_analysis[[i]]$movave <- (state_analysis[[i]]$nh4 + 
                                    lag(state_analysis[[i]]$nh4) + 
                                    lag(state_analysis[[i]]$nh4,2))/3
  #fill first year entry with just first year entry
  state_analysis[[i]][1,"movave"] <- state_analysis[[i]]$nh4[1]
  #fill second year with avg from first and second year
  state_analysis[[i]][2,"movave"] <- mean(c(state_analysis[[i]]$nh4[1],
                                           state_analysis[[i]]$nh4[2]))
  #rebind df
  nonnative_exp_final <- do.call(rbind, state_analysis)
}

nonnative_exp_final 
# nonnative_exp_final$year <- substr(nonnative_exp_final$year, 3, 4)
nonnative_exp_final$year <- as.factor(nonnative_exp_final$year)
#fill in NAs in movave column; have first year be the first year, 2nd year be 2 year moving avg
nonnative_exp_final$county_type <- "Non-American Indian"
nonnative_exp_final

## UNADJUSTED NATIONWIDE TRENDS: df for NATIONWIDE average decline, to join with table
nonnative_avgdec <- aggregate(nh4~year,
          data=nonnative_exp_final,
          FUN=mean)
nonnative_avgdec$movave <- (nonnative_avgdec$nh4 + 
                                  lag(nonnative_avgdec$nh4) + 
                                  lag(nonnative_avgdec$nh4,2))/3
nonnative_avgdec[1,"movave"] <- nonnative_avgdec$nh4[1]
#fill second year with avg from first and second year
nonnative_avgdec[2,"movave"] <- mean(c(nonnative_avgdec$nh4[1],
                                    nonnative_avgdec$nh4[2]))

# dummy columns
nonnative_avgdec$State_Name <- "Average Concentration across all States (Unadjusted)"
nonnative_avgdec$county_type <- "Non-American Indian"
nonnative_avgdec <- nonnative_avgdec %>% dplyr::select(year, State_Name, nh4, movave, county_type)
nonnative_avgdec

nh4_nai_timetrend <- ggplot() + 
  geom_line(data = nonnative_exp_final,
            aes(x=year, y = nh4,
                group = State_Name),
            color = "grey") + #unadjusted means by state
  geom_line(data=nonnative_avgdec,
            aes(x=year, y=nh4,
                group=State_Name),
            color="black",
            size = 1.25) + #unadjusted national mean
  geom_line(data= nai_nh4_adj,
            aes(x=year, y=nh4,
                group=State_Name),
            color = "purple",
            size = 1.25) + #adjusted national mean
  ylim(0, 2.5) +
  ylab(expression(paste("Annual Measured ", PM[2.5], " (", mu, "g/", m^3, ")"))) +
  labs(#title = "Non-AI Populated Counties",
       x = "Year") + theme_linedraw() +
  theme(plot.title = element_text(size = 18),
        axis.title = element_text(size = 16),
        axis.text = element_text(size = 12),
        axis.title.x=element_blank()) +
  guides(x =  guide_axis(angle = 45)) 
nh4_nai_timetrend 

# 9/7 for paper
# customlabel inside graph
grob_nai_nh4 <- grobTree(textGrob("B", x=0.05,  y=0.9, hjust=0,gp=gpar(fontsize=30)))

# Plot & save
nh4_nai_timetrend + annotation_custom(grob_nai_nh4)
# ggsave("figures/updated_10.22/nh4_nai_states.png")

```


#### NEW 5/3/2023: GREY LINE FOR ALL COUNTIES (NOT SPECIFIED BY AI-POP COUNTY TYPE)

```{r Get unadjusted mean PM2.5 for ALL counties & Plot all adj and unadj values}
# Define subsetted df for ALL counties (nh4) to be used in later chunks for unadjusted line
# Join with data to get state acronyms
nh4_ai_join <- nh4_ai_join %>% 
  dplyr::select(County, year, nh4, State)
nh4_ai_join$year <- as.factor(nh4_ai_join$year)
unique(nh4_ai_join$State_Name)
nh4_ai_join <- nh4_ai_join %>% inner_join(state_fips)
nh4_ai_join

# STATE TREND LINES: Aggregate to get an average exposure for each state per year (unadjusted)
all_state_annual_mean <- aggregate(nh4~year+State_Name,
          data=nh4_ai_join,
          FUN=mean)
all_state_annual_mean

#3 year moving avg
#separate df by state FIPS and rbind back
state_analysis <- list() #empty list for county
all_state_exp <- unique(all_state_annual_mean$State_Name)
all_exp_final <- data.frame() #empty df to rbind list items into
library(stats)
for (i in 1:length(all_state_exp)){
  #separate df by state
  state_analysis[[i]] <- all_state_annual_mean %>%
    filter(State_Name == all_state_exp[i])
  #new col of moving averages
  state_analysis[[i]] <- state_analysis[[i]] %>%
    group_by(year) %>%
    arrange(year) 
  #new column for moving averages
  state_analysis[[i]]$movave <- (state_analysis[[i]]$nh4 + 
                                    lag(state_analysis[[i]]$nh4) + 
                                    lag(state_analysis[[i]]$nh4,2))/3
  #fill first year entry with just first year entry
  state_analysis[[i]][1,"movave"] <- state_analysis[[i]]$nh4[1]
  #fill second year with avg from first and second year
  state_analysis[[i]][2,"movave"] <- mean(c(state_analysis[[i]]$nh4[1],
                                           state_analysis[[i]]$nh4[2]))
  #rebind df
  all_exp_final <- do.call(rbind, state_analysis)
}

all_exp_final 
# all_exp_final$year <- substr(all_exp_final$year, 3, 4)
all_exp_final$year <- as.factor(all_exp_final$year)
#fill in NAs in movave column; have first year be the first year, 2nd year be 2 year moving avg
all_exp_final

## UNADJUSTED NATIONWIDE TRENDS: df for NATIONWIDE average decline, to join with table
all_avgdec <- aggregate(nh4~year,
          data=all_exp_final,
          FUN=mean)
all_avgdec$movave <- (all_avgdec$nh4 + 
                                  lag(all_avgdec$nh4) + 
                                  lag(all_avgdec$nh4,2))/3
all_avgdec[1,"movave"] <- all_avgdec$nh4[1]
#fill second year with avg from first and second year
all_avgdec[2,"movave"] <- mean(c(all_avgdec$nh4[1],
                                    all_avgdec$nh4[2]))

# dummy columns
all_avgdec$State_Name <- "Average Concentration across all States (Unadjusted)"
# all_avgdec$county_type <- "NA"
all_avgdec <- all_avgdec %>% dplyr::select(year, State_Name, nh4, movave)
all_avgdec

## PLOT
nh4_all_timetrend <- ggplot() + 
  geom_line(data = all_exp_final,
            aes(x=year, y = nh4,
                group = State_Name),
            color = "grey") + #unadjusted means by state
  geom_line(data=all_avgdec,
            aes(x=year, y=nh4,
                group=State_Name),
            color="black",
            size = 1.25) + #unadjusted national mean
  # geom_line(data= nai_nh4_adj,
  #           aes(x=year, y=nh4,
  #               group=State_Name),
  #           color = "purple",
  #           size = 1.25) + #adjusted national mean
  ylim(0, 2.5) +
  ylab(expression(paste("Annual Measured ", PM[2.5], " (", mu, "g/", m^3, ")"))) +
  labs(#title = "Non-AI Populated Counties",
       x = "Year") + theme_linedraw() +
  theme(plot.title = element_text(size = 18),
        axis.title = element_text(size = 16),
        axis.text = element_text(size = 12),
        axis.title.x=element_blank()) +
  guides(x =  guide_axis(angle = 45)) 
nh4_all_timetrend 

# 9/7 for paper
# customlabel inside graph
grob_all_nh4 <- grobTree(textGrob("B", x=0.05,  y=0.9, hjust=0,gp=gpar(fontsize=30)))

# Plot & save
nh4_all_timetrend + annotation_custom(grob_all_nh4)
# ggsave("figures/updated_10.22/nh4_nai_states.png")

```
#### Attempt to combine AI and non-AI in one graph!

```{r combined graph}
## AI lines = teal
## Non-AI lines = beige

nh4_combined <- ggplot() + 
  geom_line(data = native_exp_final,
            aes(x=year, y = nh4,
                group = State_Name, colour= State_Name),
            color = "#c7eae5") + #each line = state mean
  geom_line(data = nonnative_exp_final,
            aes(x=year, y = nh4,
                group = State_Name),
            color = "#f6e8c3") + #unadjusted means by state
  geom_line(data=native_avgdec,
            aes(x=year, y=nh4,
                group=State_Name),
            color="#5ab4ac", linetype = "dashed",
            size = 1.25) + #unadjusted national mean (dashed)
  geom_line(data=nonnative_avgdec,
            aes(x=year, y=nh4,
                group=State_Name),
            color="#d8b365", linetype = "dashed",
            size = 1.25) + #unadjusted national mean
  geom_line(data= ai_nh4_adj,
            aes(x=year, y=nh4,
                group=State_Name),
            color = "#01665e",
            size = 1.25) + #adjusted national mean
  geom_line(data= nai_nh4_adj,
            aes(x=year, y=nh4,
                group=State_Name),
            color = "#8c510a",
            size = 1.25) + #adjusted national mean
  # geom_line(data=all_avgdec,
  #           aes(x=year, y=nh4,
  #               group=State_Name),
  #           color="#5A5A5A", 
  #           linetype = "dashed",
  #           size = 1.25) +
  ylim(0, 2.5) +
  ylab(expression(paste("Annual Mean ", "NH"["4"]^"+", " (", mu, "g/", m^3, ")"))) + #dont need to specify model/measured, gonna do so w/ grob
  labs(x = "Year") + theme_linedraw() +
  theme(plot.title = element_text(size = 18),
        axis.title = element_text(size = 16),
        axis.text = element_text(size = 12),
        axis.title.x=element_blank()) +
  guides(x =  guide_axis(angle = 45))
nh4_combined

# Plot & save
nh4_combined
# ggsave("figures/descriptive_graphs/nh4_trend.png")

```

```{r Layered graphs for seminar presentation 2/1/2021}
# ALL STATE LINES ONLY
nh4_statesonly <- ggplot() + 
  geom_line(data = native_exp_final,
            aes(x=year, y = nh4,
                group = State_Name, colour= State_Name),
            color = "#c7eae5") + #each line = state mean
  geom_line(data = nonnative_exp_final,
            aes(x=year, y = nh4,
                group = State_Name),
            color = "#f6e8c3") + #unadjusted means by state
  ylim(0, 20) +
  ylab(expression(paste("Annual Mean ", "NH"["4"]^"+", " (", mu, "g/", m^3, ")"))) + #dont need to specify model/measured, gonna do so w/ grob
  labs(x = "Year") + theme_linedraw() +
  theme(plot.title = element_text(size = 18),
        axis.title = element_text(size = 16),
        axis.text = element_text(size = 12),
        axis.title.x=element_blank()) +
  guides(x =  guide_axis(angle = 45)) +
  geom_hline(yintercept=12, linetype="solid", color = "red")
nh4_statesonly

# add caption/title (data source)
# nh4_statesonly + annotation_custom(grob_nh4_data)
# ggsave("presentations/layering_trends/nh4_only_states.png")

# UNADJUSTED NATIONAL MEANS WITH ALL STATES
nh4_unadj <- ggplot() + 
  geom_line(data = native_exp_final,
            aes(x=year, y = nh4,
                group = State_Name, colour= State_Name),
            color = "#c7eae5") + #each line = state mean
  geom_line(data = nonnative_exp_final,
            aes(x=year, y = nh4,
                group = State_Name),
            color = "#f6e8c3") + #unadjusted means by state
  geom_line(data=native_avgdec,
            aes(x=year, y=nh4,
                group=State_Name),
            color="#5ab4ac", linetype = "dashed",
            size = 1.25) + #unadjusted national mean (dashed)
  geom_line(data=nonnative_avgdec,
            aes(x=year, y=nh4,
                group=State_Name),
            color="#d8b365", linetype = "dashed",
            size = 1.25) + #unadjusted national mean
  ylim(0, 2.5) +
  ylab(expression(paste("Annual Mean ", NH[4], " (", mu, "g/", m^3, ")"))) + #dont need to specify model/measured, gonna do so w/ grob
  labs(x = "Year") + theme_linedraw() +
  theme(plot.title = element_text(size = 18),
        axis.title = element_text(size = 16),
        axis.text = element_text(size = 12),
        axis.title.x=element_blank()) +
  guides(x =  guide_axis(angle = 45)) 
nh4_unadj

# # add caption/title (data source)
# nh4_unadj + annotation_custom(grob_nh4_data)
# ggsave("figures/descriptive_graphs/nh4_unadj.png")
# 
# # FULL GRAPH WITH ALL THE LINES
# nh4_combined + annotation_custom(grob_nh4_data)
# ggsave("presentations/layering_trends/nh4_full.png") 
```

